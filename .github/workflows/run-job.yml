name: Run jarvisbot Job

on:
  create:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Job branch to run (e.g., job/abc123)'
        required: true
        type: string

jobs:
  run-agent:
    runs-on: ubuntu-latest
    # Run on create event for job/* branches, OR on manual dispatch with any branch input
    if: |
      (github.event_name == 'create' && github.ref_type == 'branch' && startsWith(github.ref_name, 'job/')) ||
      (github.event_name == 'workflow_dispatch')
    permissions:
      contents: write
      packages: read

    steps:
      - name: Set branch name
        id: branch
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "name=${{ inputs.branch }}" >> $GITHUB_OUTPUT
          else
            echo "name=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Login to GHCR
        if: startsWith(vars.IMAGE_URL, 'ghcr.io/')
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run jarvisbot Agent
        env:
          IMAGE_URL: ${{ vars.IMAGE_URL }}
          MODEL: ${{ vars.MODEL }}
        run: |
          if [ -n "$IMAGE_URL" ]; then
            IMAGE="${IMAGE_URL}:latest"
          else
            IMAGE="stephengpope/thepopebot:latest"
          fi
          echo "Using image: $IMAGE"
          echo "Running branch: ${{ steps.branch.outputs.name }}"
          docker run --rm \
            -e REPO_URL="${{ github.server_url }}/${{ github.repository }}.git" \
            -e BRANCH="${{ steps.branch.outputs.name }}" \
            -e SECRETS='${{ secrets.SECRETS }}' \
            -e LLM_SECRETS='${{ secrets.LLM_SECRETS }}' \
            -e MODEL="${MODEL}" \
            "$IMAGE"
